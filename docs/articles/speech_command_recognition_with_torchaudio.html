<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Speech Command Recognition With Torchaudio • torchaudio</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Speech Command Recognition With Torchaudio">
<meta property="og:description" content="torchaudio">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-2WGS9CPRN1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2WGS9CPRN1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">torchaudio</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/audio_preprocessing_tutorial.html">Audio I/O and Pre-Processing with torchaudio</a>
    </li>
    <li>
      <a href="../articles/speech_command_recognition_with_torchaudio.html">Speech Command Recognition With Torchaudio</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/curso-r/torchaudio">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="speech_command_recognition_with_torchaudio_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Speech Command Recognition With Torchaudio</h1>
            
      
      
      <div class="hidden name"><code>speech_command_recognition_with_torchaudio.Rmd</code></div>

    </div>

    
    
<blockquote>
<p>Note: This is an R port of the official tutorial available <a href="https://pytorch.org/tutorials/intermediate/speech_command_recognition_with_torchaudio.html">here</a>. All credits goes to <a href="https://vincentqb.github.io/">Vincent Quenneville-Bélair</a>.</p>
</blockquote>
<p>This tutorial will show you how to correctly format an audio dataset and then train/test an audio classifier network on the dataset.</p>
<p>First, let’s import the <a href="https://github.com/curso-r/torchaudio">{torchaudio}</a> package from Github. Not on CRAN yet.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"># Uncomment to install {torchaudio} package from Github. Not on CRAN yet.
# remotes::install_github("curso-r/torchaudio")</pre></body></html></div>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">torch</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">torchaudio</span>)</pre></body></html></div>
<p>Let’s check if a CUDA GPU is available and select our device. Running the network on a GPU will greatly decrease the training/testing runtime.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">device</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_device.html">torch_device</a></span>(<span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/pkg/torch/man/cuda_is_available.html">cuda_is_available</a></span>()) <span class="st">"cuda"</span> <span class="kw">else</span> <span class="st">"cpu"</span>)
<span class="no">device</span>
<span class="co">#&gt; torch_device(type='cpu')</span></pre></body></html></div>
<div id="importing-the-dataset" class="section level1">
<h1 class="hasAnchor">
<a href="#importing-the-dataset" class="anchor"></a>Importing the Dataset</h1>
<p>We use {torchaudio} to download and represent the dataset. Here we use <a href="https://arxiv.org/abs/1804.03209"><code>SpeechCommands</code></a>, which is a datasets of 35 commands spoken by different people. The dataset <code><a href="../reference/speechcommand_dataset.html">speechcommand_dataset()</a></code> is a <code><a href="https://rdrr.io/pkg/torch/man/dataset.html">torch::dataset()</a></code> version of the dataset. In this dataset, all audio files are about 1 second long (and so about 16000 time frames long).</p>
<p>The actual loading and formatting steps happen when a data point is being accessed, and {torchaudio} takes care of converting the audio files to tensors. If one wants to load an audio file directly instead, <code><a href="../reference/torchaudio_load.html">torchaudio_load()</a></code> can be used. It returns a list containing the newly created tensor along with the sampling frequency of the audio file (16kHz for <code>SpeechCommands</code>).</p>
<p>Going back to the dataset, here we create a subclass that splits it into standard training, validation, testing subsets.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">subset_sc</span> <span class="kw">&lt;-</span> <span class="kw pkg">torch</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataset.html">dataset</a></span>(
  <span class="st">"SubsetSC"</span>,
  <span class="kw">inherit</span> <span class="kw">=</span> <span class="no">speechcommand_dataset</span>,
  <span class="kw">initialize</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">subset</span> <span class="kw">=</span> <span class="kw">NULL</span>) {
    <span class="no">super</span>$<span class="fu">initialize</span>(<span class="st">"."</span>, <span class="kw">download</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

    <span class="no">load_list</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">filename</span>) {
      <span class="no">filepath</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">self</span>$<span class="no">.path</span>, <span class="no">filename</span>)
      <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="no">filepath</span>)
    }

    <span class="kw">if</span>(<span class="no">subset</span> <span class="kw">==</span> <span class="st">"validation"</span>) {
      <span class="no">self</span>$<span class="no">.walker</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">self</span>$<span class="no">.path</span>, <span class="st">"/"</span>, <span class="fu">load_list</span>(<span class="st">"validation_list.txt"</span>))
    } <span class="kw">else</span> <span class="kw">if</span>(<span class="no">subset</span> <span class="kw">==</span> <span class="st">"testing"</span>) {
      <span class="no">self</span>$<span class="no">.walker</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">self</span>$<span class="no">.path</span>, <span class="st">"/"</span>, <span class="fu">load_list</span>(<span class="st">"testing_list.txt"</span>))
    } <span class="kw">else</span> <span class="kw">if</span>(<span class="no">subset</span> <span class="kw">==</span> <span class="st">"training"</span>) {
      <span class="no">excludes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">load_list</span>(<span class="st">"validation_list.txt"</span>), <span class="fu">load_list</span>(<span class="st">"testing_list.txt"</span>))
      <span class="no">self</span>$<span class="no">.walker</span> <span class="kw">&lt;-</span> <span class="no">self</span>$<span class="no">.walker</span>[!<span class="no">self</span>$<span class="no">.walker</span> <span class="kw">%in%</span> <span class="no">excludes</span>]
    }
  }
)

<span class="co"># Create training and testing split of the data. We do not use validation in this tutorial.</span>
<span class="no">train_set</span> <span class="kw">&lt;-</span> <span class="fu">subset_sc</span>(<span class="st">"training"</span>)
<span class="no">test_set</span> <span class="kw">&lt;-</span> <span class="fu">subset_sc</span>(<span class="st">"testing"</span>)

<span class="co"># sample &lt;- list(waveform, sample_rate, label, speaker_id, utterance_number)</span>
<span class="no">sample</span> <span class="kw">&lt;-</span> <span class="no">train_set</span>[<span class="fl">1</span>]

<span class="no">waveform</span> <span class="kw">&lt;-</span> <span class="no">sample</span><span class="kw">[[</span><span class="fl">1</span>]]
<span class="no">sample_rate</span> <span class="kw">&lt;-</span> <span class="no">sample</span><span class="kw">[[</span><span class="fl">2</span>]]
<span class="no">label</span> <span class="kw">&lt;-</span> <span class="no">sample</span><span class="kw">[[</span><span class="fl">3</span>]]
<span class="no">speaker_id</span> <span class="kw">&lt;-</span> <span class="no">sample</span><span class="kw">[[</span><span class="fl">4</span>]]
<span class="no">utterance_number</span> <span class="kw">&lt;-</span> <span class="no">sample</span><span class="kw">[[</span><span class="fl">5</span>]]</pre></body></html></div>
<p>A data point in the SPEECHCOMMANDS dataset is a list made of a waveform (the audio signal), the sample rate, the utterance (label), the ID of the speaker, the number of the utterance.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Shape of waveform: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">waveform</span>), <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">" "</span>))
<span class="co">#&gt; [1] "Shape of waveform:  1 16000"</span>
<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Sample rate of waveform: "</span>, <span class="no">sample_rate</span>)
<span class="co">#&gt; [1] "Sample rate of waveform:  16000"</span>

<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">waveform</span>[<span class="fl">1</span>], <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"royalblue"</span>)</pre></body></html></div>
<p><img src="speech_command_recognition_with_torchaudio_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>Let’s find the list of labels available in the dataset.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">labels</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq.int</a></span>(<span class="no">train_set</span>), <span class="kw">function</span>(<span class="no">i</span>) <span class="no">train_set</span>[<span class="no">i</span>]$<span class="no">label</span>)))
<span class="no">labels</span></pre></body></html></div>
<pre><code>#&gt;  [1] "backward" "bed"      "bird"     "cat"      "dog"      "down"    
#&gt;  [7] "eight"    "five"     "follow"   "forward"  "four"     "go"      
#&gt; [13] "happy"    "house"    "learn"    "left"     "marvin"   "nine"    
#&gt; [19] "no"       "off"      "on"       "one"      "right"    "seven"   
#&gt; [25] "sheila"   "six"      "stop"     "three"    "tree"     "two"     
#&gt; [31] "up"       "visual"   "wow"      "yes"      "zero"</code></pre>
<p>The 35 audio labels are commands that are said by users. The first few files are people saying “marvin”.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"># library(embedr) # for audio player. remotes::install_github("mccarthy-m-g/embedr")
# embed_audio(normalizePath(train_set$.walker[1]))</pre></body></html></div>
<div class="sourceCode" id="cb9"><html><body><pre class="r"># embed_audio(normalizePath(train_set$.walker[2]))</pre></body></html></div>
<p>The last file is someone saying “visual”.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"># embed_audio(normalizePath(train_set$.walker[length(train_set)]))</pre></body></html></div>
</div>
<div id="formatting-the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#formatting-the-data" class="anchor"></a>Formatting the Data</h1>
<p>This is a good place to apply transformations to the data. For the waveform, we downsample the audio for faster processing without losing too much of the classification power.</p>
<p>We don’t need to apply other transformations here. It is common for some datasets though to have to reduce the number of channels (say from stereo to mono) by either taking the mean along the channel dimension, or simply keeping only one of the channels.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">new_sample_rate</span> <span class="kw">&lt;-</span> <span class="fl">8000</span>
<span class="no">transform</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/transform_resample.html">transform_resample</a></span>(<span class="kw">orig_freq</span> <span class="kw">=</span> <span class="no">sample_rate</span>, <span class="kw">new_freq</span> <span class="kw">=</span> <span class="no">new_sample_rate</span>)$<span class="fu">to</span>(<span class="kw">device</span> <span class="kw">=</span> <span class="no">device</span>)

<span class="no">transformed</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span>(<span class="no">waveform</span>)

<span class="co"># embed_audio(transformed)</span></pre></body></html></div>
<p>We are encoding each word using its index in the list of labels.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">label_to_index</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">word</span>) {
 <span class="co"># Return the position of the word in labels</span>
 <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw pkg">torch</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">labels</span> <span class="kw">==</span> <span class="no">word</span>)))
}

<span class="no">index_to_label</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">index</span>) {
 <span class="co"># Return the word corresponding to the index in labels</span>
 <span class="co"># This is the inverse of label_to_index</span>
 <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">labels</span>[<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">index</span>$<span class="fu">to</span>(<span class="kw">device</span> <span class="kw">=</span> <span class="st">"cpu"</span>))])
}

<span class="no">word_start</span> <span class="kw">&lt;-</span> <span class="st">"yes"</span>
<span class="no">index</span> <span class="kw">&lt;-</span> <span class="fu">label_to_index</span>(<span class="no">word_start</span>)
<span class="no">word_recovered</span> <span class="kw">&lt;-</span> <span class="fu">index_to_label</span>(<span class="no">index</span>)

<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">word_start</span>, <span class="st">"--&gt;"</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">index</span>), <span class="st">"--&gt;"</span>, <span class="no">word_recovered</span>)
<span class="co">#&gt; [1] "yes --&gt; 34 --&gt; yes"</span></pre></body></html></div>
<p>To turn a list of data point made of audio recordings and utterances into two batched tensors for the model, we implement a collate function which is used by the <code><a href="https://rdrr.io/pkg/torch/man/dataloader.html">torch::dataloader</a></code> that allows us to iterate over a dataset by batches.</p>
<p>In the collate function, we also apply the resampling, and the text encoding.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">pad_sequence</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">batch</span>) {
  <span class="co"># Make all tensor in a batch the same length by padding with zeros</span>
  <span class="no">batch</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">batch</span>, <span class="kw">function</span>(<span class="no">x</span>) (<span class="no">x</span>$<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>()))
  <span class="no">batch</span> <span class="kw">&lt;-</span> <span class="kw pkg">torch</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_utils_rnn_pad_sequence.html">nn_utils_rnn_pad_sequence</a></span>(<span class="no">batch</span>, <span class="kw">batch_first</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">padding_value</span> <span class="kw">=</span> <span class="fl">0.</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">batch</span>$<span class="fu">permute</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span>)))
}

<span class="no">collate_fn</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">batch</span>) {

 <span class="co"># A list has the form:</span>
 <span class="co"># list of lists: (waveform, sample_rate, label, speaker_id, utterance_number)</span>
 <span class="co"># Transpose it</span>
 <span class="no">batch</span> <span class="kw">&lt;-</span> <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="no">batch</span>)
 <span class="no">tensors</span> <span class="kw">&lt;-</span> <span class="no">batch</span>$<span class="no">waveform</span>
 <span class="no">targets</span> <span class="kw">&lt;-</span> <span class="no">batch</span>$<span class="no">label</span>

 <span class="co"># Group the list of tensors into a batched tensor</span>
 <span class="no">tensors</span> <span class="kw">&lt;-</span> <span class="fu">pad_sequence</span>(<span class="no">tensors</span>)
 <span class="no">targets</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">targets</span>, <span class="no">label_to_index</span>)
 <span class="no">targets</span> <span class="kw">&lt;-</span> <span class="kw pkg">torch</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_stack.html">torch_stack</a></span>(<span class="no">targets</span>)

 <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">tensors</span> <span class="kw">=</span> <span class="no">tensors</span>, <span class="kw">targets</span> <span class="kw">=</span> <span class="no">targets</span>))
}

<span class="no">batch_size</span> <span class="kw">&lt;-</span> <span class="fl">256</span>

<span class="kw">if</span>(<span class="no">device</span>$<span class="no">type</span> <span class="kw">==</span> <span class="st">"cuda"</span>) {
  <span class="no">num_workers</span> <span class="kw">&lt;-</span> <span class="fl">1</span>
  <span class="no">pin_memory</span> <span class="kw">&lt;-</span> <span class="fl">TRUE</span>
} <span class="kw">else</span> {
  <span class="no">num_workers</span> <span class="kw">&lt;-</span> <span class="fl">0</span>
  <span class="no">pin_memory</span> <span class="kw">&lt;-</span> <span class="fl">FALSE</span>
}

<span class="no">train_loader</span> <span class="kw">=</span> <span class="kw pkg">torch</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span>(
  <span class="no">train_set</span>,
  <span class="kw">batch_size</span> <span class="kw">=</span> <span class="no">batch_size</span>,
  <span class="kw">shuffle</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
  <span class="kw">collate_fn</span> <span class="kw">=</span> <span class="no">collate_fn</span>,
  <span class="kw">num_workers</span> <span class="kw">=</span> <span class="no">num_workers</span>,
  <span class="kw">pin_memory</span> <span class="kw">=</span> <span class="no">pin_memory</span>
)

<span class="no">test_loader</span>  <span class="kw">=</span> <span class="kw pkg">torch</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span>(
  <span class="no">test_set</span>,
  <span class="kw">batch_size</span> <span class="kw">=</span> <span class="no">batch_size</span>,
  <span class="kw">shuffle</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">drop_last</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">collate_fn</span> <span class="kw">=</span> <span class="no">collate_fn</span>,
  <span class="kw">num_workers</span> <span class="kw">=</span> <span class="no">num_workers</span>,
  <span class="kw">pin_memory</span> <span class="kw">=</span> <span class="no">pin_memory</span>
)</pre></body></html></div>
</div>
<div id="define-the-network" class="section level1">
<h1 class="hasAnchor">
<a href="#define-the-network" class="anchor"></a>Define the Network</h1>
<p>For this tutorial we will use a convolutional neural network to process the raw audio data. Usually more advanced transforms are applied to the audio data, however CNNs can be used to accurately process the raw data. The specific architecture is modeled after the M5 network architecture described in <a href="https://arxiv.org/pdf/1610.00087.pdf">this paper</a>. An important aspect of models processing raw audio data is the receptive field of their first layer’s filters. Our model’s first filter is length 80 so when processing audio sampled at 8kHz the receptive field is around 10ms (and at 4kHz, around 20 ms). This size is similar to speech processing applications that often use receptive fields ranging from 20ms to 40ms.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">M5</span> <span class="kw">&lt;-</span> <span class="kw pkg">torch</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_module.html">nn_module</a></span>(
  <span class="st">"M5"</span>,
  <span class="kw">initialize</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">n_input</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="no">n_output</span> <span class="kw">=</span> <span class="fl">35</span>, <span class="no">stride</span> <span class="kw">=</span> <span class="fl">16</span>, <span class="no">n_channel</span> <span class="kw">=</span> <span class="fl">32</span>) {
    <span class="no">self</span>$<span class="no">conv1</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv1d.html">nn_conv1d</a></span>(<span class="no">n_input</span>, <span class="no">n_channel</span>, <span class="kw">kernel_size</span><span class="kw">=</span><span class="fl">80</span>, <span class="kw">stride</span><span class="kw">=</span><span class="no">stride</span>)
    <span class="no">self</span>$<span class="no">bn1</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_batch_norm1d.html">nn_batch_norm1d</a></span>(<span class="no">n_channel</span>)
    <span class="no">self</span>$<span class="no">pool1</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_max_pool1d.html">nn_max_pool1d</a></span>(<span class="fl">4</span>)
    <span class="no">self</span>$<span class="no">conv2</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv1d.html">nn_conv1d</a></span>(<span class="no">n_channel</span>, <span class="no">n_channel</span>, <span class="kw">kernel_size</span><span class="kw">=</span><span class="fl">3</span>)
    <span class="no">self</span>$<span class="no">bn2</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_batch_norm1d.html">nn_batch_norm1d</a></span>(<span class="no">n_channel</span>)
    <span class="no">self</span>$<span class="no">pool2</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_max_pool1d.html">nn_max_pool1d</a></span>(<span class="fl">4</span>)
    <span class="no">self</span>$<span class="no">conv3</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv1d.html">nn_conv1d</a></span>(<span class="no">n_channel</span>, <span class="fl">2</span> * <span class="no">n_channel</span>, <span class="kw">kernel_size</span><span class="kw">=</span><span class="fl">3</span>)
    <span class="no">self</span>$<span class="no">bn3</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_batch_norm1d.html">nn_batch_norm1d</a></span>(<span class="fl">2</span> * <span class="no">n_channel</span>)
    <span class="no">self</span>$<span class="no">pool3</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_max_pool1d.html">nn_max_pool1d</a></span>(<span class="fl">4</span>)
    <span class="no">self</span>$<span class="no">conv4</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv1d.html">nn_conv1d</a></span>(<span class="fl">2</span> * <span class="no">n_channel</span>, <span class="fl">2</span> * <span class="no">n_channel</span>, <span class="kw">kernel_size</span><span class="kw">=</span><span class="fl">3</span>)
    <span class="no">self</span>$<span class="no">bn4</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_batch_norm1d.html">nn_batch_norm1d</a></span>(<span class="fl">2</span> * <span class="no">n_channel</span>)
    <span class="no">self</span>$<span class="no">pool4</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_max_pool1d.html">nn_max_pool1d</a></span>(<span class="fl">4</span>)
    <span class="no">self</span>$<span class="no">fc1</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span>(<span class="fl">2</span> * <span class="no">n_channel</span>, <span class="no">n_output</span>)
  },

  <span class="kw">forward</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) {
    <span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">conv1</span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">bn1</span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_relu.html">nnf_relu</a></span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">pool1</span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">conv2</span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">bn2</span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_relu.html">nnf_relu</a></span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">pool2</span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">conv3</span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">bn3</span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_relu.html">nnf_relu</a></span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">pool3</span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">conv4</span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">bn4</span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_relu.html">nnf_relu</a></span>() <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">pool4</span>()

    <span class="no">out</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_avg_pool1d.html">nnf_avg_pool1d</a></span>(<span class="no">x</span>, <span class="no">x</span>$<span class="no">shape</span>[<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x</span>$<span class="no">shape</span>)], <span class="kw">stride</span> <span class="kw">=</span> <span class="fl">1</span>)$<span class="fu">permute</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span>)) <span class="kw">%&gt;%</span>
      <span class="no">self</span>$<span class="fu">fc1</span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_log_softmax.html">nnf_log_softmax</a></span>(<span class="kw">dim</span> <span class="kw">=</span> <span class="fl">3L</span>)

    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">out</span>)
  }
)

<span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu">M5</span>(<span class="kw">n_input</span> <span class="kw">=</span> <span class="no">transformed</span>$<span class="no">shape</span>[<span class="fl">1</span>], <span class="kw">n_output</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">labels</span>))
<span class="no">model</span>$<span class="fu">to</span>(<span class="kw">device</span> <span class="kw">=</span> <span class="no">device</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">model</span>$<span class="no">parameters</span>)
<span class="co">#&gt; List of 18</span>
<span class="co">#&gt;  $ conv1.weight:Float [1:32, 1:1, 1:80]</span>
<span class="co">#&gt;  $ conv1.bias  :Float [1:32]</span>
<span class="co">#&gt;  $ bn1.weight  :Float [1:32]</span>
<span class="co">#&gt;  $ bn1.bias    :Float [1:32]</span>
<span class="co">#&gt;  $ conv2.weight:Float [1:32, 1:32, 1:3]</span>
<span class="co">#&gt;  $ conv2.bias  :Float [1:32]</span>
<span class="co">#&gt;  $ bn2.weight  :Float [1:32]</span>
<span class="co">#&gt;  $ bn2.bias    :Float [1:32]</span>
<span class="co">#&gt;  $ conv3.weight:Float [1:64, 1:32, 1:3]</span>
<span class="co">#&gt;  $ conv3.bias  :Float [1:64]</span>
<span class="co">#&gt;  $ bn3.weight  :Float [1:64]</span>
<span class="co">#&gt;  $ bn3.bias    :Float [1:64]</span>
<span class="co">#&gt;  $ conv4.weight:Float [1:64, 1:64, 1:3]</span>
<span class="co">#&gt;  $ conv4.bias  :Float [1:64]</span>
<span class="co">#&gt;  $ bn4.weight  :Float [1:64]</span>
<span class="co">#&gt;  $ bn4.bias    :Float [1:64]</span>
<span class="co">#&gt;  $ fc1.weight  :Float [1:35, 1:64]</span>
<span class="co">#&gt;  $ fc1.bias    :Float [1:35]</span></pre></body></html></div>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">count_parameters</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">model</span>) {
  <span class="no">requires</span> <span class="kw">&lt;-</span> <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl</a></span>(<span class="no">model</span>$<span class="no">parameters</span>, ~<span class="no">.</span>$<span class="no">requires_grad</span>)
  <span class="no">params</span> <span class="kw">&lt;-</span> <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_int</a></span>(<span class="no">model</span>$<span class="no">parameters</span>[<span class="no">requires</span>], ~<span class="no">.</span>$<span class="fu">numel</span>())
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">params</span>)
}

<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fu">count_parameters</span>(<span class="no">model</span>)
<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Number of parameters: "</span>, <span class="no">n</span>)
<span class="co">#&gt; [1] "Number of parameters:  26915"</span></pre></body></html></div>
<p>We will use the same optimization technique used in the paper, an Adam optimizer with weight decay set to 0.0001. At first, we will train with a learning rate of 0.01, but we will use a <code>scheduler</code> to decrease it to 0.001 during training after 20 epochs.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">optimizer</span> <span class="kw">&lt;-</span> <span class="kw pkg">torch</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span>(<span class="no">model</span>$<span class="no">parameters</span>, <span class="kw">lr</span> <span class="kw">=</span> <span class="fl">0.01</span>, <span class="kw">weight_decay</span> <span class="kw">=</span> <span class="fl">0.0001</span>)
<span class="no">scheduler</span> <span class="kw">&lt;-</span> <span class="kw pkg">torch</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/lr_step.html">lr_step</a></span>(<span class="no">optimizer</span>, <span class="kw">step_size</span> <span class="kw">=</span> <span class="fl">20</span>, <span class="kw">gamma</span> <span class="kw">=</span> <span class="fl">0.1</span>)  <span class="co"># reduce the learning after 20 epochs by a factor of 10</span></pre></body></html></div>
</div>
<div id="training-and-testing-the-network" class="section level1">
<h1 class="hasAnchor">
<a href="#training-and-testing-the-network" class="anchor"></a>Training and Testing the Network</h1>
<p>Now let’s define a training function that will feed our training data into the model and perform the backward pass and optimization steps. For training, the loss we will use is the negative log-likelihood. The network will then be tested after each epoch to see how the accuracy varies during the training.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">train</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">model</span>, <span class="no">epoch</span>, <span class="no">log_interval</span>) {
  <span class="no">model</span>$<span class="fu">train</span>()

  <span class="no">batches</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/enumerate.html">enumerate</a></span>(<span class="no">train_loader</span>)
  <span class="kw">for</span>(<span class="no">batch_idx</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">batches</span>)) {
    <span class="no">batch</span> <span class="kw">&lt;-</span> <span class="no">batches</span>[<span class="no">batch_idx</span>]<span class="kw">[[</span><span class="fl">1</span>]]
    <span class="no">data</span> <span class="kw">&lt;-</span> <span class="no">batch</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="fu">to</span>(<span class="kw">device</span> <span class="kw">=</span> <span class="no">device</span>)
    <span class="no">target</span> <span class="kw">&lt;-</span> <span class="no">batch</span><span class="kw">[[</span><span class="fl">2</span>]]$<span class="fu">to</span>(<span class="kw">device</span> <span class="kw">=</span> <span class="no">device</span>)

    <span class="co"># apply transform and model on whole batch directly on device</span>
    <span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span>(<span class="no">data</span>)
    <span class="no">output</span> <span class="kw">&lt;-</span> <span class="fu">model</span>(<span class="no">data</span>)
    <span class="co"># negative log-likelihood for a tensor of size (batch x 1 x n_output)</span>
    <span class="no">loss</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_nll_loss.html">nnf_nll_loss</a></span>(<span class="no">output</span>$<span class="fu">squeeze</span>(), <span class="no">target</span>$<span class="fu">squeeze</span>())

    <span class="no">optimizer</span>$<span class="fu">zero_grad</span>()
    <span class="no">loss</span>$<span class="fu">backward</span>()
    <span class="no">optimizer</span>$<span class="fu"><a href="https://rdrr.io/r/stats/step.html">step</a></span>()

    <span class="co"># update progress bar</span>
    <span class="no">pbar</span>$<span class="fu">tick</span>(<span class="kw">tokens</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">loss</span> <span class="kw">=</span> <span class="no">loss</span>$<span class="fu">item</span>()))

    <span class="co"># record loss</span>
    <span class="no">losses</span> <span class="kw">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">losses</span>, <span class="no">loss</span>$<span class="fu">item</span>())
  }
}</pre></body></html></div>
<p>Now that we have a training function, we need to make one for testing the networks accuracy. We will set the model to <code><a href="https://rdrr.io/r/base/eval.html">eval()</a></code> mode and then run inference on the test dataset. Calling <code><a href="https://rdrr.io/r/base/eval.html">eval()</a></code> sets the training variable in all modules in the network to false. Certain layers like batch normalization and dropout layers behave differently during training so this step is crucial for getting correct results.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">number_of_correct</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">pred</span>, <span class="no">target</span>) {
 <span class="co"># count number of correct predictions</span>
 <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">pred</span>$<span class="fu">squeeze</span>()$<span class="fu">eq</span>(<span class="no">target</span>)$<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>()$<span class="fu">item</span>())
}

<span class="no">get_likely_index</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">tensor</span>) {
 <span class="co"># find most likely label index for each element in the batch</span>
 <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">tensor</span>$<span class="fu">argmax</span>(<span class="kw">dim</span><span class="kw">=</span>-<span class="fl">1L</span>))
}

<span class="no">test</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">model</span>, <span class="no">epoch</span>) {
  <span class="no">model</span>$<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>()
  <span class="no">correct</span> <span class="kw">&lt;-</span> <span class="fl">0</span>
  <span class="no">batches</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/enumerate.html">enumerate</a></span>(<span class="no">test_loader</span>)
  <span class="kw">for</span>(<span class="no">batch_idx</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">batches</span>)) {
    <span class="no">batch</span> <span class="kw">&lt;-</span> <span class="no">batches</span>[<span class="no">batch_idx</span>]<span class="kw">[[</span><span class="fl">1</span>]]
    <span class="no">data</span> <span class="kw">&lt;-</span> <span class="no">batch</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="fu">to</span>(<span class="kw">device</span> <span class="kw">=</span> <span class="no">device</span>)
    <span class="no">target</span> <span class="kw">&lt;-</span> <span class="no">batch</span><span class="kw">[[</span><span class="fl">2</span>]]$<span class="fu">to</span>(<span class="kw">device</span> <span class="kw">=</span> <span class="no">device</span>)

    <span class="co"># apply transform and model on whole batch directly on device</span>
    <span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span>(<span class="no">data</span>)
    <span class="no">output</span> <span class="kw">&lt;-</span> <span class="fu">model</span>(<span class="no">data</span>)

    <span class="no">pred</span> <span class="kw">&lt;-</span> <span class="fu">get_likely_index</span>(<span class="no">output</span>)
    <span class="no">correct</span> <span class="kw">&lt;-</span> <span class="no">correct</span> + <span class="fu">number_of_correct</span>(<span class="no">pred</span>, <span class="no">target</span>)

    <span class="co"># update progress bar</span>
    <span class="no">pbar</span>$<span class="fu">tick</span>()
  }

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw pkg">glue</span><span class="kw ns">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"
Test Epoch: {epoch} Accuracy: {correct}/{length(test_loader$dataset)} ({scales::percent(correct / length(test_loader$dataset))})"</span>))
}</pre></body></html></div>
<p>Finally, we can train and test the network. We will train the network for ten epochs then reduce the learn rate and train for ten more epochs. The network will be tested after each epoch to see how the accuracy varies during the training.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">log_interval</span> <span class="kw">&lt;-</span> <span class="fl">20</span>
<span class="no">n_epoch</span> <span class="kw">&lt;-</span> <span class="fl">5</span>

<span class="no">losses</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>()

<span class="co"># The transform needs to live on the same device as the model and the data.</span>
<span class="no">transform</span> <span class="kw">&lt;-</span> <span class="no">transform</span>$<span class="fu">to</span>(<span class="kw">device</span> <span class="kw">=</span> <span class="no">device</span>)
<span class="kw">for</span>(<span class="no">epoch</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq.int</a></span>(<span class="no">n_epoch</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Epoch "</span>, <span class="no">epoch</span>, <span class="st">"/"</span>, <span class="no">n_epoch</span>, <span class="st">"\n"</span>))
  <span class="no">pbar</span> <span class="kw">&lt;-</span> <span class="kw pkg">progress</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/progress/man/progress_bar.html">progress_bar</a></span>$<span class="fu">new</span>(<span class="kw">total</span> <span class="kw">=</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">train_loader</span>) + <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">test_loader</span>)), <span class="kw">clear</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">width</span> <span class="kw">=</span> <span class="fl">90</span>,
                                   <span class="kw">incomplete</span> <span class="kw">=</span> <span class="st">"."</span>, <span class="kw">format</span> <span class="kw">=</span> <span class="st">"[:bar] [:current/:total :percent] - ETA: :eta - loss: :loss"</span>)

  <span class="fu">train</span>(<span class="no">model</span>, <span class="no">epoch</span>, <span class="no">log_interval</span>)
  <span class="fu">test</span>(<span class="no">model</span>, <span class="no">epoch</span>)
  <span class="no">scheduler</span>$<span class="fu"><a href="https://rdrr.io/r/stats/step.html">step</a></span>()
}</pre></body></html></div>
<p>Let’s plot the training loss versus the number of iteration.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">losses</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="st">"training loss"</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"royalblue"</span>)</pre></body></html></div>
<p><img src="speech_command_recognition_with_torchaudio_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<p>The network should be more than 65% accurate on the test set after 2 epochs, and 85% after 21 epochs. Let’s look at the last words in the train set, and see how the model did on it.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">predict</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">tensor</span>) {
 <span class="co"># Use the model to predict the label of the waveform</span>
 <span class="no">tensor</span> <span class="kw">&lt;-</span> <span class="no">tensor</span>$<span class="fu">to</span>(<span class="kw">device</span> <span class="kw">=</span> <span class="no">device</span>) <span class="kw">%&gt;%</span>
   <span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span>() <span class="kw">%&gt;%</span>
   {<span class="no">.</span>$<span class="fu">unsqueeze</span>(<span class="fl">1L</span>)} <span class="kw">%&gt;%</span>
   <span class="fu">model</span>() <span class="kw">%&gt;%</span>
   <span class="fu">get_likely_index</span>() <span class="kw">%&gt;%</span>
   {<span class="no">.</span>$<span class="fu">squeeze</span>()} <span class="kw">%&gt;%</span>
   <span class="fu">index_to_label</span>()

 <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">tensor</span>)
}

<span class="no">sample</span> <span class="kw">&lt;-</span> <span class="no">train_set</span>[<span class="fl">2000</span>]
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw pkg">glue</span><span class="kw ns">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"Expected: {sample[[3]]}. Predicted: {predict(sample[[1]])}."</span>))
<span class="co">#&gt; Expected: bed. Predicted: tree.</span></pre></body></html></div>
</div>
<div id="conclusion" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h1>
<p>In this tutorial, we used {torchaudio} to load a dataset and resample the signal. We have then defined a neural network that we trained to recognize a given command. There are also other data preprocessing methods, such as finding the mel frequency cepstral coefficients (MFCC), that can reduce the size of the dataset. This transform is also available in {torchaudio} as <code>torchaudio::transforms_mfcc</code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/athospd">Athos Damiani</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
